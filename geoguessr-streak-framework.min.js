var __awaiter=this&&this.__awaiter||function(e,t,n,u){function i(o){return o instanceof n?o:new n(function(a){a(o)})}return new(n||(n=Promise))(function(o,a){function r(s){try{l(u.next(s))}catch(c){a(c)}}function d(s){try{l(u.throw(s))}catch(c){a(c)}}function l(s){s.done?o(s.value):i(s.value).then(r,d)}l((u=u.apply(e,t||[])).next())})};const DEFAULT_DATA={checking_api:!1,streak:0,previous_streak:0,streak_backup:0,country_guess:null,country_location:null,last_guess_identifier:null},ENABLED_ON_CHALLENGES=!0,AUTOMATIC=!0,LANGUAGE="en",STORAGE_IDENTIFIER="geoCountryStreak";let STREAK_DATA=DEFAULT_DATA;const CountryDict={AX:"FI",AS:"US",AI:"GB",AW:"NL",BM:"GB",BQ:"NL",BV:"NO",IO:"GB",KY:"UK",CX:"AU",CC:"AU",CK:"NZ",CW:"NL",FK:"GB",FO:"DK",GF:"FR",PF:"FR",TF:"FR",GI:"UK",GL:"DK",GP:"FR",GU:"US",GG:"GB",HM:"AU",HK:"CN",IM:"GB",JE:"GB",MO:"CN",MQ:"FR",YT:"FR",MS:"GB",AN:"NL",NC:"FR",NU:"NZ",NF:"AU",MP:"US",PS:"IL",PN:"GB",PR:"US",RE:"FR",BL:"FR",SH:"GB",MF:"FR",PM:"FR",SX:"NL",GS:"GB",SJ:"NO",TK:"NZ",TC:"GB",UM:"US",VG:"GB",VI:"US",WF:"FR",EH:"MA"};function loadData(){STREAK_DATA=DEFAULT_DATA;let e=window.localStorage.getItem(STORAGE_IDENTIFIER);if(!e)return;let t=JSON.parse(e);t&&(t.checking_api=!1,Object.assign(STREAK_DATA,t),saveData())}function saveData(){window.localStorage.setItem(STORAGE_IDENTIFIER,JSON.stringify(STREAK_DATA))}function getRoundPanel(){return document.getElementById("country-streak-counter-panel")}function getSummaryPanel(){return document.getElementById("country-streak-score-panel-summary")}function updateRoundPanel(){var e,t,n;if(!getRoundPanel()){let o=document.querySelector('.game-layout__status div[class^="status_section"][data-qa="score"]');if(o){let a=document.createElement("div");a.id="country-streak-counter-panel",a.style.display="flex";let r=(e=o.querySelector('div[class^="status_label"]'))===null||e===void 0?void 0:e.className,d=(t=o.querySelector('div[class^="status_value"]'))===null||t===void 0?void 0:t.className;a.innerHTML=`<div class="${o.getAttribute("class")}"><div class="${r}">STREAK</div><div id="country-streak-counter-value" class="${d}"></div></div>`,(n=o.parentNode)===null||n===void 0||n.append(a)}}let i=document.getElementById("country-streak-counter-value");i&&(i.innerText=STREAK_DATA.streak.toString())}function createStreakText(){if(STREAK_DATA.checking_api)return"Loading...";if(STREAK_DATA.streak>0)return`It was <span style="color:#6cb928">${STREAK_DATA.country_location}!</span> Country Streak: <span style="color:#fecd19">${STREAK_DATA.streak}</span>`;{let e="countries in a row.";switch(STREAK_DATA.previous_streak){case 1:e="country."}let t="You didn't make a guess.";return STREAK_DATA.country_guess&&(t=`You guessed <span style="color:#f95252">${STREAK_DATA.country_guess}</span>, unfortunately it was <span style="color:#6cb928">${STREAK_DATA.country_location}</span>.`),`${t} Your streak ended after correctly guessing <span style="color:#fecd19">${STREAK_DATA.previous_streak}</span> ${e}`}}function createStreakElement(){let e=document.createElement("div");return e.style.fontSize="18px",e.style.fontWeight="500",e.style.color="#fff",e.style.padding="10px",e.style.paddingBottom="0",e.style.position="absolute",e.style.bottom="100%",e.style.width="100%",e.style.background="var(--ds-color-purple-100)",e}function updateSummaryPanel(){var e;const t=document.querySelector('div[class^="result-layout_root"] div[class^="round-result_wrapper__"]');if(t){let n=getSummaryPanel();n||(n=createStreakElement(),n.id="country-streak-score-panel-summary",(e=t.parentNode)===null||e===void 0||e.insertBefore(n,t)),n.innerHTML=createStreakText()}}function updateStreakPanels(){updateRoundPanel(),updateSummaryPanel()}function queryOSM(e){return __awaiter(this,void 0,void 0,function*(){let t=`https://nominatim.openstreetmap.org/reverse.php?lat=${e.lat}&lon=${e.lng}&zoom=21&format=jsonv2&accept-language=${LANGUAGE}`;return yield fetch(t).then(n=>n.json())})}function disableAutoStreak(e){return!AUTOMATIC||e.is_challenge_link&&!ENABLED_ON_CHALLENGES}function stopRound(e){var t,n,u,i,o,a;return __awaiter(this,void 0,void 0,function*(){if(disableAutoStreak(e))return;STREAK_DATA.checking_api=!0,updateStreakPanels();const r=e.rounds[e.current_round-1],d=`${e.current_game_id}-${e.current_round}`;if(d==STREAK_DATA.last_guess_identifier){STREAK_DATA.checking_api=!1,console.log("same as last guess"),updateStreakPanels();return}if(STREAK_DATA.last_guess_identifier=d,r.location.lat==null||r.location.lng==null||r.player_guess.lat==null||r.player_guess.lng==null){STREAK_DATA.checking_api=!1,STREAK_DATA.country_guess=null,STREAK_DATA.country_location=null,updateStreak(0);return}const l=yield queryOSM(r.player_guess),s=yield queryOSM(r.location);STREAK_DATA.checking_api=!1;const c=((n=(t=l?.address)===null||t===void 0?void 0:t.country_code)===null||n===void 0?void 0:n.toUpperCase())||null,p=((i=(u=s?.address)===null||u===void 0?void 0:u.country_code)===null||i===void 0?void 0:i.toUpperCase())||null;STREAK_DATA.country_guess=((o=l?.address)===null||o===void 0?void 0:o.country)||"Undefined",STREAK_DATA.country_location=((a=s?.address)===null||a===void 0?void 0:a.country)||"Undefined",c&&p&&(CountryDict[c]||c)===(CountryDict[p]||p)?updateStreak(STREAK_DATA.streak+1):updateStreak(0)})}function checkStreakIsLatest(){let e=window.localStorage.getItem(STORAGE_IDENTIFIER);if(!e)return;let t=JSON.parse(e);t&&(STREAK_DATA.streak=t.streak)}const updateStreak=e=>{checkStreakIsLatest(),STREAK_DATA.previous_streak=STREAK_DATA.streak,STREAK_DATA.streak=e,STREAK_DATA.streak!==0&&(STREAK_DATA.streak_backup=STREAK_DATA.streak),saveData(),updateStreakPanels()};document.addEventListener("keypress",e=>{if(!(!getRoundPanel()&&!getSummaryPanel()))switch(e.key){case"1":updateStreak(STREAK_DATA.streak+1);break;case"2":updateStreak(STREAK_DATA.streak-1);break;case"8":updateStreak(STREAK_DATA.streak_backup+1);break;case"0":STREAK_DATA.streak_backup=0,updateStreak(0);break}}),loadData(),window.onload=updateStreakPanels,GeoGuessrEventFramework.init().then(e=>{e.events.addEventListener("round_start",t=>{console.log(`round ${t.detail.current_round} started`,t.detail),updateRoundPanel()}),e.events.addEventListener("round_end",t=>{console.log(`round ${t.detail.current_round} ended`,t.detail),stopRound(t.detail)})});
