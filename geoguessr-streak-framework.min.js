var __awaiter=this&&this.__awaiter||function(d,e,t,s){function i(a){return a instanceof t?a:new t(function(n){n(a)})}return new(t||(t=Promise))(function(a,n){function r(u){try{o(s.next(u))}catch(c){n(c)}}function l(u){try{o(s.throw(u))}catch(c){n(c)}}function o(u){u.done?a(u.value):i(u.value).then(r,l)}o((s=s.apply(d,e||[])).next())})};const CC_DICT={AX:"FI",AS:"US",AI:"GB",AW:"NL",BM:"GB",BQ:"NL",BV:"NO",IO:"GB",KY:"UK",CX:"AU",CC:"AU",CK:"NZ",CW:"NL",FK:"GB",FO:"DK",GF:"FR",PF:"FR",TF:"FR",GI:"UK",GL:"DK",GP:"FR",GU:"US",GG:"GB",HM:"AU",HK:"CN",IM:"GB",JE:"GB",MO:"CN",MQ:"FR",YT:"FR",MS:"GB",AN:"NL",NC:"FR",NU:"NZ",NF:"AU",MP:"US",PS:"IL",PN:"GB",PR:"US",RE:"FR",BL:"FR",SH:"GB",MF:"FR",PM:"FR",SX:"NL",GS:"GB",SJ:"NO",TK:"NZ",TC:"GB",UM:"US",VG:"GB",VI:"US",WF:"FR",EH:"MA"};class GeoGuessrStreakFramework{constructor(e){if(this.options=e,this.state=this.defaultState(),this.current_round=0,this.should_update_round_panel=!1,this.should_update_summary_panel=!1,typeof this.options.storage_identifier=="string"&&(this.options.storage_identifier=this.options.storage_identifier.replace(/[^\w\d-_]/g,""),this.options.storage_identifier.length==0))throw new Error("'storage_identifier' must not be blank and can only contain letters, digits, underscores, and hyphens.");const t={storage_identifier:"geoguessr-streak-framework",name:"Country Streak",terms:{single:"country",plural:"countries"},enabled_on_challenges:!0,automatic:!0,language:"en",streak_type:"round",only_match_country_code:!0,query_openstreetmap:!0,address_matches:["country"],keyboard_shortcuts:{increment:"1",decrement:"2",reset:"0",restore:"8"}};this.options=Object.assign(t,this.options),this.loadState(),this.setupKeyboardShortcuts(),window.addEventListener("load",this.updateStreakPanels.bind(this));const s=unsafeWindow||window;if(!s.GeoGuessrEventFramework)throw new Error("GeoGuessr Streak Framework requires GeoGuessr Event Framework (https://github.com/miraclewhips/geoguessr-event-framework). Please include this before you include GeoGuessr Streak Framework.");this.events=s.GeoGuessrEventFramework,this.events.init().then(i=>{console.log("GeoGuessr Streak Framework initialised.");const a=()=>{let n=document.querySelector("#__next");if(!n)return;new MutationObserver(this.checkState.bind(this)).observe(n,{subtree:!0,childList:!0}),i.events.addEventListener("round_start",o=>{this.current_round=o.detail.current_round,this.should_update_round_panel=!0,this.updateStreakPanels()});const l=this.options.streak_type==="game"?"game_end":"round_end";i.events.addEventListener(l,o=>{this.should_update_summary_panel=!0,this.stopRound(o.detail)})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",a):a()})}defaultState(){return{checking_api:!1,streak:0,previous_streak:0,streak_backup:0,guess_name:null,location_name:null,last_guess_identifier:null}}loadState(){this.state=this.defaultState();let e=JSON.parse(window.localStorage.getItem(this.options.storage_identifier));e&&(e.checking_api=!1,Object.assign(this.state,e),this.saveState())}saveState(){window.localStorage.setItem(this.options.storage_identifier,JSON.stringify(this.state))}getRoundPanel(){return document.getElementById(`streak-counter-panel-${this.options.storage_identifier}`)}getSummaryPanel(){return document.getElementById(`streak-score-panel-summary-${this.options.storage_identifier}`)}updateRoundPanel(){if(!this.getRoundPanel()){let s=document.querySelector('div[class^="game_status__"] div[class^="status_section"][data-qa="score"]');if(s){let i=document.createElement("div");i.id=`streak-counter-panel-${this.options.storage_identifier}`,i.style.display="flex";let a=s.querySelector('div[class^="status_label"]').className,n=s.querySelector('div[class^="status_value"]').className;i.innerHTML=`<div class="${s.getAttribute("class")}"><div class="${a}">${this.options.name.toUpperCase()}</div><div id="streak-counter-value-${this.options.storage_identifier}" class="${n}"></div></div>`,s.parentNode.append(i)}}let t=document.getElementById(`streak-counter-value-${this.options.storage_identifier}`);t&&(t.innerText=this.state.streak.toString())}createStreakText(){if(this.state.checking_api)return"Loading...";if(this.state.streak>0)return this.state.guess_name||this.state.location_name?`It was <span style="color:#6cb928">${this.state.guess_name||this.state.location_name}!</span> ${this.options.name}: <span style="color:#fecd19">${this.state.streak}</span>`:`${this.options.name}: <span style="color:#fecd19">${this.state.streak}</span>`;{let e=`${this.options.terms.plural} in a row.`;switch(this.state.previous_streak){case 1:e=`${this.options.terms.single}.`}let t="";return this.state.guess_name&&this.state.location_name&&(t=`You guessed <span style="color:#f95252">${this.state.guess_name}</span>, unfortunately it was <span style="color:#6cb928">${this.state.location_name}</span>.`),`${t} Your streak ended after <span style="color:#fecd19">${this.state.previous_streak}</span> ${e}`}}createStreakElement(){let e=document.createElement("div");return e.style.fontSize="18px",e.style.fontWeight="500",e.style.color="#fff",e.style.padding="10px",e.style.paddingBottom="0",e.style.background="var(--ds-color-purple-100)",e}updateSummaryPanel(){if(this.options.streak_type==="game"&&this.current_round!==5)return;const e=document.querySelector('div[class^="result-layout_root"] div[class^="round-result_wrapper__"]'),t=document.querySelector('div[class^="result-layout_root"] div[class^="result-layout_bottomNew__"]');if(t&&(t.style.flex="0",t.style.maxHeight="none"),!e&&!t)return;let s=this.getSummaryPanel();e&&!s&&(s=this.createStreakElement(),s.id=`streak-score-panel-summary-${this.options.storage_identifier}`,e.parentNode.insertBefore(s,e)),s&&(s.innerHTML=this.createStreakText())}updateStreakPanels(){this.updateRoundPanel(),this.updateSummaryPanel()}queryOSM(e){return __awaiter(this,void 0,void 0,function*(){let t=`https://nominatim.openstreetmap.org/reverse.php?lat=${e.lat}&lon=${e.lng}&zoom=18&format=jsonv2&accept-language=${this.options.language}`;return yield fetch(t).then(s=>s.json())})}isAutoStreakDisabled(e){return!this.options.automatic||e.is_challenge_link&&!this.options.enabled_on_challenges}matchCountryCode(e){var t;let s=(t=e?.country_code)===null||t===void 0?void 0:t.toUpperCase();return s?CC_DICT[s]||s:null}matchAddress(e){if(e&&this.options.address_matches&&this.options.address_matches.length>0){for(let t of this.options.address_matches)if(e[t])return e[t]}return"Undefined"}stopRound(e){return __awaiter(this,void 0,void 0,function*(){if(this.isAutoStreakDisabled(e))return;this.updateStreakPanels();const t=e.rounds[e.current_round-1];if(!t)return;const s=`${e.current_game_id}-${e.current_round}`;if(s==this.state.last_guess_identifier){this.updateStreakPanels();return}if(this.state.last_guess_identifier=s,this.saveState(),t.location.lat==null||t.location.lng==null||t.player_guess.lat==null||t.player_guess.lng==null){this.state.guess_name=null,this.state.location_name=null,this.setStreakValue(0);return}let i=!1;if(this.state.checking_api=!0,this.options.query_openstreetmap){this.updateStreakPanels();const a=yield this.queryOSM(t.player_guess),n=yield this.queryOSM(t.location);if(this.options.custom_match_function){const r=yield this.options.custom_match_function(this.events.state,a,n);this.state.checking_api=!1,this.state.guess_name=r.player_guess_name,this.state.location_name=r.actual_location_name,i=r.match}else{this.state.checking_api=!1;const r=this.matchCountryCode(a?.address),l=this.matchCountryCode(n?.address);this.state.guess_name=this.matchAddress(a?.address),this.state.location_name=this.matchAddress(n?.address);const o=r&&l&&r===l,u=this.state.guess_name===this.state.location_name;i=o&&(u||this.options.only_match_country_code)}}else{const a=yield this.options.custom_match_function(this.events.state,t.player_guess,t.location);this.state.checking_api=!1,this.state.guess_name=a.player_guess_name,this.state.location_name=a.actual_location_name,i=a.match}this.updateStreakPanels(),i?this.incrementStreakValue(1):this.setStreakValue(0)})}checkStreakIsLatest(){let e=JSON.parse(window.localStorage.getItem(this.options.storage_identifier));e&&(this.state.streak=e.streak)}incrementStreakValue(e){this.checkStreakIsLatest(),this.setStreakValue(this.state.streak+e)}setStreakValue(e){this.checkStreakIsLatest(),this.state.previous_streak=this.state.streak,this.state.streak=e,this.state.streak!==0&&(this.state.streak_backup=this.state.streak),this.saveState(),this.updateStreakPanels()}setupKeyboardShortcuts(){let e=this.options.keyboard_shortcuts;document.addEventListener("keypress",t=>{if(!(!this.getRoundPanel()&&!this.getSummaryPanel()))switch(t.key){case e.reset:this.setStreakValue(0);break;case e.increment:this.incrementStreakValue(1);break;case e.decrement:this.incrementStreakValue(-1);break;case e.restore:this.setStreakValue(this.state.streak_backup+1);break}})}checkState(){const e=document.querySelector('div[class^="in-game_root__"]');if(!e)return;const t=document.querySelector('div[class^="game_status__"]'),s=document.querySelector('div[class^="round-result_wrapper__"]'),i=document.querySelector('div[class^="result-layout_root__"] div[class^="result-overlay_overlayContent__"]'),a=this.should_update_round_panel||!this.getRoundPanel(),n=this.should_update_summary_panel||!this.getSummaryPanel();e&&(t&&a?(this.should_update_round_panel=!1,this.updateRoundPanel()):(s||i)&&n&&(this.should_update_summary_panel=!1,this.updateSummaryPanel()))}}
