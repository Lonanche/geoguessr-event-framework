var __awaiter=this&&this.__awaiter||function(d,t,e,s){function a(i){return i instanceof e?i:new e(function(n){n(i)})}return new(e||(e=Promise))(function(i,n){function r(o){try{l(s.next(o))}catch(c){n(c)}}function u(o){try{l(s.throw(o))}catch(c){n(c)}}function l(o){o.done?i(o.value):a(o.value).then(r,u)}l((s=s.apply(d,t||[])).next())})};const CC_DICT={AX:"FI",AS:"US",AI:"GB",AW:"NL",BM:"GB",BQ:"NL",BV:"NO",IO:"GB",KY:"UK",CX:"AU",CC:"AU",CK:"NZ",CW:"NL",FK:"GB",FO:"DK",GF:"FR",PF:"FR",TF:"FR",GI:"UK",GL:"DK",GP:"FR",GU:"US",GG:"GB",HM:"AU",HK:"CN",IM:"GB",JE:"GB",MO:"CN",MQ:"FR",YT:"FR",MS:"GB",AN:"NL",NC:"FR",NU:"NZ",NF:"AU",MP:"US",PS:"IL",PN:"GB",PR:"US",RE:"FR",BL:"FR",SH:"GB",MF:"FR",PM:"FR",SX:"NL",GS:"GB",SJ:"NO",TK:"NZ",TC:"GB",UM:"US",VG:"GB",VI:"US",WF:"FR",EH:"MA"};class GeoGuessrStreakFramework{constructor(t){if(this.options=t,this.events=new EventTarget,this.state=this.defaultState(),typeof this.options.storage_identifier=="string"&&(this.options.storage_identifier=this.options.storage_identifier.replace(/[^\w\d-_]/g,""),this.options.storage_identifier.length==0))throw new Error("'storage_identifier' must not be blank and can only contain letters, digits, underscores, and hyphens.");const e={storage_identifier:"geoguessr-streak-framework",name:"Country Streak",terms:{single:"country",plural:"countries"},enabled_on_challenges:!0,automatic:!0,language:"en",only_match_country_code:!0,address_matches:["country"],query_openstreetmap:!0};if(this.options=Object.assign(e,this.options),this.loadState(),this.setupKeyboardShortcuts(),window.addEventListener("load",this.updateStreakPanels.bind(this)),!GeoGuessrEventFramework)throw new Error("GeoGuessr Streak Framework requires GeoGuessr Event Framework (https://github.com/miraclewhips/geoguessr-event-framework). Please include this before you include GeoGuessr Streak Framework.");GeoGuessrEventFramework.init().then(s=>{s.events.addEventListener("round_start",a=>{console.log(`round ${a.detail.current_round} started`,a.detail),this.updateRoundPanel()}),s.events.addEventListener("round_end",a=>{console.log(`round ${a.detail.current_round} ended`,a.detail),this.stopRound(a.detail)})})}defaultState(){return{checking_api:!1,streak:0,previous_streak:0,streak_backup:0,guess_name:null,location_name:null,last_guess_identifier:null}}loadState(){this.state=this.defaultState();let t=JSON.parse(window.localStorage.getItem(this.options.storage_identifier));t&&(t.checking_api=!1,Object.assign(this.state,t),this.saveState())}saveState(){window.localStorage.setItem(this.options.storage_identifier,JSON.stringify(this.state))}getRoundPanel(){return document.getElementById(`streak-counter-panel-${this.options.storage_identifier}`)}getSummaryPanel(){return document.getElementById(`streak-score-panel-summary-${this.options.storage_identifier}`)}updateRoundPanel(){if(!this.getRoundPanel()){let s=document.querySelector('.game-layout__status div[class^="status_section"][data-qa="score"]');if(s){let a=document.createElement("div");a.id=`streak-counter-panel-${this.options.storage_identifier}`,a.style.display="flex";let i=s.querySelector('div[class^="status_label"]').className,n=s.querySelector('div[class^="status_value"]').className;a.innerHTML=`<div class="${s.getAttribute("class")}"><div class="${i}">${this.options.name.toUpperCase()}</div><div id="streak-counter-value-${this.options.storage_identifier}" class="${n}"></div></div>`,s.parentNode.append(a)}}let e=document.getElementById(`streak-counter-value-${this.options.storage_identifier}`);e&&(e.innerText=this.state.streak.toString())}createStreakText(){if(this.state.checking_api)return"Loading...";if(this.state.streak>0)return`It was <span style="color:#6cb928">${this.state.location_name}!</span> ${this.options.name}: <span style="color:#fecd19">${this.state.streak}</span>`;{let t=`${this.options.terms.plural} in a row.`;switch(this.state.previous_streak){case 1:t=`${this.options.terms.single}.`}let e="You didn't make a guess.";return this.state.guess_name&&(e=`You guessed <span style="color:#f95252">${this.state.guess_name}</span>, unfortunately it was <span style="color:#6cb928">${this.state.location_name}</span>.`),`${e} Your streak ended after correctly guessing <span style="color:#fecd19">${this.state.previous_streak}</span> ${t}`}}createStreakElement(){let t=document.createElement("div");return t.style.fontSize="18px",t.style.fontWeight="500",t.style.color="#fff",t.style.padding="10px",t.style.paddingBottom="0",t.style.position="absolute",t.style.bottom="100%",t.style.width="100%",t.style.background="var(--ds-color-purple-100)",t}updateSummaryPanel(){const t=document.querySelector('div[class^="result-layout_root"] div[class^="round-result_wrapper__"]');if(t){let e=this.getSummaryPanel();e||(e=this.createStreakElement(),e.id=`streak-score-panel-summary-${this.options.storage_identifier}`,t.parentNode.insertBefore(e,t)),e.innerHTML=this.createStreakText()}}updateStreakPanels(){this.updateRoundPanel(),this.updateSummaryPanel()}queryOSM(t){return __awaiter(this,void 0,void 0,function*(){let e=`https://nominatim.openstreetmap.org/reverse.php?lat=${t.lat}&lon=${t.lng}&zoom=18&format=jsonv2&accept-language=${this.options.language}`;return yield fetch(e).then(s=>s.json())})}isAutoStreakDisabled(t){return!this.options.automatic||t.is_challenge_link&&!this.options.enabled_on_challenges}matchCountryCode(t){var e;let s=(e=t?.country_code)===null||e===void 0?void 0:e.toUpperCase();return s?CC_DICT[s]||s:null}matchAddress(t){if(t&&this.options.address_matches&&this.options.address_matches.length>0){for(let e of this.options.address_matches)if(t[e])return t[e]}return"Undefined"}stopRound(t){return __awaiter(this,void 0,void 0,function*(){if(this.isAutoStreakDisabled(t))return;this.updateStreakPanels();const e=t.rounds[t.current_round-1],s=`${t.current_game_id}-${t.current_round}`;if(s==this.state.last_guess_identifier){this.updateStreakPanels();return}if(this.state.last_guess_identifier=s,e.location.lat==null||e.location.lng==null||e.player_guess.lat==null||e.player_guess.lng==null){this.state.guess_name=null,this.state.location_name=null,this.setStreakValue(0);return}let a=!1;if(this.options.query_openstreetmap){this.state.checking_api=!0,this.updateStreakPanels();const i=yield this.queryOSM(e.player_guess),n=yield this.queryOSM(e.location);if(this.state.checking_api=!1,this.options.custom_match_function){let r=this.options.custom_match_function(i,n);this.state.guess_name=r.guess_name,this.state.location_name=r.location_name,a=r.guess_name==r.location_name}else{const r=this.matchCountryCode(i?.address),u=this.matchCountryCode(n?.address);this.state.guess_name=this.matchAddress(i?.address),this.state.location_name=this.matchAddress(n?.address);const l=r&&u&&r===u,o=this.state.guess_name===this.state.location_name;a=l&&(o||this.options.only_match_country_code)}}else a=this.options.custom_match_function(e.player_guess,e.location);a?this.incrementStreakValue(1):this.setStreakValue(0)})}checkStreakIsLatest(){let t=JSON.parse(window.localStorage.getItem(this.options.storage_identifier));t&&(this.state.streak=t.streak)}incrementStreakValue(t){this.checkStreakIsLatest(),this.setStreakValue(this.state.streak+t)}setStreakValue(t){this.checkStreakIsLatest(),this.state.previous_streak=this.state.streak,this.state.streak=t,this.state.streak!==0&&(this.state.streak_backup=this.state.streak),this.saveState(),this.updateStreakPanels()}setupKeyboardShortcuts(){document.addEventListener("keypress",t=>{if(!(!this.getRoundPanel()&&!this.getSummaryPanel()))switch(t.key){case"1":this.incrementStreakValue(1);break;case"2":this.incrementStreakValue(-1);break;case"8":this.setStreakValue(this.state.streak_backup);break;case"0":this.state.streak!==0&&(this.state.streak_backup=this.state.streak),this.setStreakValue(0);break}})}}
