var __awaiter=this&&this.__awaiter||function(d,t,e,s){function i(a){return a instanceof e?a:new e(function(n){n(a)})}return new(e||(e=Promise))(function(a,n){function r(o){try{l(s.next(o))}catch(c){n(c)}}function u(o){try{l(s.throw(o))}catch(c){n(c)}}function l(o){o.done?a(o.value):i(o.value).then(r,u)}l((s=s.apply(d,t||[])).next())})};const CC_DICT={AX:"FI",AS:"US",AI:"GB",AW:"NL",BM:"GB",BQ:"NL",BV:"NO",IO:"GB",KY:"UK",CX:"AU",CC:"AU",CK:"NZ",CW:"NL",FK:"GB",FO:"DK",GF:"FR",PF:"FR",TF:"FR",GI:"UK",GL:"DK",GP:"FR",GU:"US",GG:"GB",HM:"AU",HK:"CN",IM:"GB",JE:"GB",MO:"CN",MQ:"FR",YT:"FR",MS:"GB",AN:"NL",NC:"FR",NU:"NZ",NF:"AU",MP:"US",PS:"IL",PN:"GB",PR:"US",RE:"FR",BL:"FR",SH:"GB",MF:"FR",PM:"FR",SX:"NL",GS:"GB",SJ:"NO",TK:"NZ",TC:"GB",UM:"US",VG:"GB",VI:"US",WF:"FR",EH:"MA"};class GeoGuessrStreakFramework{constructor(t){if(this.options=t,this.state=this.defaultState(),this.current_round=0,this.should_update_round_panel=!1,this.should_update_summary_panel=!1,typeof this.options.storage_identifier=="string"&&(this.options.storage_identifier=this.options.storage_identifier.replace(/[^\w\d-_]/g,""),this.options.storage_identifier.length==0))throw new Error("'storage_identifier' must not be blank and can only contain letters, digits, underscores, and hyphens.");const e={storage_identifier:"geoguessr-streak-framework",name:"Country Streak",terms:{single:"country",plural:"countries"},enabled_on_challenges:!0,automatic:!0,language:"en",streak_type:"round",only_match_country_code:!0,query_openstreetmap:!0,address_matches:["country"],keyboard_shortcuts:{increment:"1",decrement:"2",reset:"0",restore:"8"}};this.options=Object.assign(e,this.options),this.loadState(),this.setupKeyboardShortcuts(),window.addEventListener("load",this.updateStreakPanels.bind(this));const s=unsafeWindow||window;if(!s.GeoGuessrEventFramework)throw new Error("GeoGuessr Streak Framework requires GeoGuessr Event Framework (https://github.com/miraclewhips/geoguessr-event-framework). Please include this before you include GeoGuessr Streak Framework.");this.events=s.GeoGuessrEventFramework,this.events.init().then(i=>{console.log("GeoGuessr Streak Framework initialised.");let a=document.querySelector("#__next");if(!a)return;new MutationObserver(this.checkState.bind(this)).observe(a,{subtree:!0,childList:!0}),i.events.addEventListener("round_start",u=>{this.current_round=u.detail.current_round,this.should_update_round_panel=!0,this.updateStreakPanels()});const r=this.options.streak_type==="game"?"game_end":"round_end";i.events.addEventListener(r,u=>{this.should_update_summary_panel=!0,this.stopRound(u.detail)})})}defaultState(){return{checking_api:!1,streak:0,previous_streak:0,streak_backup:0,guess_name:null,location_name:null,last_guess_identifier:null}}loadState(){this.state=this.defaultState();let t=JSON.parse(window.localStorage.getItem(this.options.storage_identifier));t&&(t.checking_api=!1,Object.assign(this.state,t),this.saveState())}saveState(){window.localStorage.setItem(this.options.storage_identifier,JSON.stringify(this.state))}getRoundPanel(){return document.getElementById(`streak-counter-panel-${this.options.storage_identifier}`)}getSummaryPanel(){return document.getElementById(`streak-score-panel-summary-${this.options.storage_identifier}`)}updateRoundPanel(){if(!this.getRoundPanel()){let s=document.querySelector('div[class^="game_status__"] div[class^="status_section"][data-qa="score"]');if(s){let i=document.createElement("div");i.id=`streak-counter-panel-${this.options.storage_identifier}`,i.style.display="flex";let a=s.querySelector('div[class^="status_label"]').className,n=s.querySelector('div[class^="status_value"]').className;i.innerHTML=`<div class="${s.getAttribute("class")}"><div class="${a}">${this.options.name.toUpperCase()}</div><div id="streak-counter-value-${this.options.storage_identifier}" class="${n}"></div></div>`,s.parentNode.append(i)}}let e=document.getElementById(`streak-counter-value-${this.options.storage_identifier}`);e&&(e.innerText=this.state.streak.toString())}createStreakText(){if(this.state.checking_api)return"Loading...";if(this.state.streak>0)return this.state.guess_name||this.state.location_name?`It was <span style="color:#6cb928">${this.state.guess_name||this.state.location_name}!</span> ${this.options.name}: <span style="color:#fecd19">${this.state.streak}</span>`:`${this.options.name}: <span style="color:#fecd19">${this.state.streak}</span>`;{let t=`${this.options.terms.plural} in a row.`;switch(this.state.previous_streak){case 1:t=`${this.options.terms.single}.`}let e="";return this.state.guess_name&&this.state.location_name&&(e=`You guessed <span style="color:#f95252">${this.state.guess_name}</span>, unfortunately it was <span style="color:#6cb928">${this.state.location_name}</span>.`),`${e} Your streak ended after <span style="color:#fecd19">${this.state.previous_streak}</span> ${t}`}}createStreakElement(){let t=document.createElement("div");return t.style.fontSize="18px",t.style.fontWeight="500",t.style.color="#fff",t.style.padding="10px",t.style.paddingBottom="0",t.style.background="var(--ds-color-purple-100)",t}updateSummaryPanel(){if(this.options.streak_type==="game"&&this.current_round!==5)return;const t=document.querySelector('div[class^="result-layout_root"] div[class^="round-result_wrapper__"]'),e=document.querySelector('div[class^="result-layout_root"] div[class^="result-layout_bottomNew__"]');if(e&&(e.style.flex="0",e.style.maxHeight="none"),!t&&!e)return;let s=this.getSummaryPanel();t&&!s&&(s=this.createStreakElement(),s.id=`streak-score-panel-summary-${this.options.storage_identifier}`,t.parentNode.insertBefore(s,t)),s&&(s.innerHTML=this.createStreakText())}updateStreakPanels(){this.updateRoundPanel(),this.updateSummaryPanel()}queryOSM(t){return __awaiter(this,void 0,void 0,function*(){let e=`https://nominatim.openstreetmap.org/reverse.php?lat=${t.lat}&lon=${t.lng}&zoom=18&format=jsonv2&accept-language=${this.options.language}`;return yield fetch(e).then(s=>s.json())})}isAutoStreakDisabled(t){return!this.options.automatic||t.is_challenge_link&&!this.options.enabled_on_challenges}matchCountryCode(t){var e;let s=(e=t?.country_code)===null||e===void 0?void 0:e.toUpperCase();return s?CC_DICT[s]||s:null}matchAddress(t){if(t&&this.options.address_matches&&this.options.address_matches.length>0){for(let e of this.options.address_matches)if(t[e])return t[e]}return"Undefined"}stopRound(t){return __awaiter(this,void 0,void 0,function*(){if(this.isAutoStreakDisabled(t))return;this.updateStreakPanels();const e=t.rounds[t.current_round-1];if(!e)return;const s=`${t.current_game_id}-${t.current_round}`;if(s==this.state.last_guess_identifier){this.updateStreakPanels();return}if(this.state.last_guess_identifier=s,this.saveState(),e.location.lat==null||e.location.lng==null||e.player_guess.lat==null||e.player_guess.lng==null){this.state.guess_name=null,this.state.location_name=null,this.setStreakValue(0);return}let i=!1;if(this.state.checking_api=!0,this.options.query_openstreetmap){this.updateStreakPanels();const a=yield this.queryOSM(e.player_guess),n=yield this.queryOSM(e.location);if(this.options.custom_match_function){const r=yield this.options.custom_match_function(this.events.state,a,n);this.state.checking_api=!1,this.state.guess_name=r.player_guess_name,this.state.location_name=r.actual_location_name,i=r.match}else{this.state.checking_api=!1;const r=this.matchCountryCode(a?.address),u=this.matchCountryCode(n?.address);this.state.guess_name=this.matchAddress(a?.address),this.state.location_name=this.matchAddress(n?.address);const l=r&&u&&r===u,o=this.state.guess_name===this.state.location_name;i=l&&(o||this.options.only_match_country_code)}}else{const a=yield this.options.custom_match_function(this.events.state,e.player_guess,e.location);this.state.checking_api=!1,this.state.guess_name=a.player_guess_name,this.state.location_name=a.actual_location_name,i=a.match}this.updateStreakPanels(),i?this.incrementStreakValue(1):this.setStreakValue(0)})}checkStreakIsLatest(){let t=JSON.parse(window.localStorage.getItem(this.options.storage_identifier));t&&(this.state.streak=t.streak)}incrementStreakValue(t){this.checkStreakIsLatest(),this.setStreakValue(this.state.streak+t)}setStreakValue(t){this.checkStreakIsLatest(),this.state.previous_streak=this.state.streak,this.state.streak=t,this.state.streak!==0&&(this.state.streak_backup=this.state.streak),this.saveState(),this.updateStreakPanels()}setupKeyboardShortcuts(){let t=this.options.keyboard_shortcuts;document.addEventListener("keypress",e=>{if(!(!this.getRoundPanel()&&!this.getSummaryPanel()))switch(e.key){case t.reset:this.setStreakValue(0);break;case t.increment:this.incrementStreakValue(1);break;case t.decrement:this.incrementStreakValue(-1);break;case t.restore:this.setStreakValue(this.state.streak_backup+1);break}})}checkState(){const t=document.querySelector('div[class^="in-game_root__"]');if(!t)return;const e=document.querySelector('div[class^="game_status__"]'),s=document.querySelector('div[class^="round-result_wrapper__"]'),i=document.querySelector('div[class^="result-layout_root__"] div[class^="result-overlay_overlayContent__"]'),a=this.should_update_round_panel||!this.getRoundPanel(),n=this.should_update_summary_panel||!this.getSummaryPanel();t&&(e&&a?(this.should_update_round_panel=!1,this.updateRoundPanel()):(s||i)&&n&&(this.should_update_summary_panel=!1,this.updateSummaryPanel()))}}
