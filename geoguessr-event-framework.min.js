var __awaiter=this&&this.__awaiter||function(c,h,l,u){function _(d){return d instanceof l?d:new l(function(o){o(d)})}return new(l||(l=Promise))(function(d,o){function e(a){try{s(u.next(a))}catch(v){o(v)}}function n(a){try{s(u.throw(a))}catch(v){o(v)}}function s(a){a.done?d(a.value):_(a.value).then(e,n)}s((u=u.apply(c,h||[])).next())})},GeoGuessrEventFramework;(function(){let c;const h=unsafeWindow||window,l=h.fetch;h.fetch=function(){return function(...o){return __awaiter(this,void 0,void 0,function*(){if(/geoguessr.com\/api\/v3\/(games|challenges)\//.test(o[0].toString())){let e=yield l.apply(h,o);return c=yield e.clone().json(),e}return l.apply(h,o)})}}();function u(o){return c&&c.round===o.current_round?c:null}function _(o){for(var e=o.toString(),n="",s=0;s<e.length;s+=2)n+=String.fromCharCode(parseInt(e.substr(s,2),16));return n}class d{constructor(){this.events=new EventTarget,this.state=this.defaultState(),this.init(),this.loadState();let e=document.querySelector("#__next");if(!e)return;new MutationObserver(this.checkState.bind(this)).observe(e,{subtree:!0,childList:!0})}init(){return __awaiter(this,void 0,void 0,function*(){return this.loadedPromise||(this.loadedPromise=Promise.resolve(this)),this.loadedPromise})}defaultState(){return{current_game_id:"",is_challenge_link:!1,current_round:0,round_in_progress:!1,game_in_progress:!0,total_score:{amount:0,unit:"points",percentage:0},total_distance:{meters:{amount:0,unit:"km"},miles:{amount:0,unit:"miles"}},rounds:[],map:{id:"",name:""}}}loadState(){let e=window.localStorage.getItem("GeoGuessrEventFramework_STATE");if(!e)return;let n=JSON.parse(e);e&&(n.current_round=0,n.round_in_progress=!1,n.game_in_progress=!0,Object.assign(this.state,this.defaultState(),n),this.saveState())}saveState(){window.localStorage.setItem("GeoGuessrEventFramework_STATE",JSON.stringify(this.state))}getCurrentRound(){const e=document.querySelector('div[class^="status_inner__"]>div[data-qa="round-number"]'),n=e?.children[1].textContent;return n?parseInt(n.split(/\//gi)[0].trim()):0}getGameMode(){if(location.pathname.startsWith("/game/"))return"game";if(location.pathname.startsWith("/challenge/"))return"challenge"}getGameId(){return window.location.href.substring(window.location.href.lastIndexOf("/")+1)}startRound(){return __awaiter(this,void 0,void 0,function*(){if(!this.getGameMode())return;this.state.current_game_id!==this.getGameId()&&(this.state=this.defaultState()),this.state.current_round=this.getCurrentRound(),this.state.round_in_progress=!0,this.state.game_in_progress=!0,this.state.current_game_id=this.getGameId(),this.state.is_challenge_link=this.getGameMode()=="challenge";let e=u(this.state);e&&(this.state.map={id:e.map,name:e.mapName}),this.saveState(),this.state.current_round===1&&this.events.dispatchEvent(new CustomEvent("game_start",{detail:this.state})),this.events.dispatchEvent(new CustomEvent("round_start",{detail:this.state}))})}stopRound(){var e,n,s,a,v,m,p,g,f,S,w,y,E,G,I,k,b,C,F,x,D,R,q,N,O,T,z,W,A;return __awaiter(this,void 0,void 0,function*(){this.state.round_in_progress=!1;let i=u(this.state);if(i){const r=i.rounds[this.state.current_round-1],t=i.player.guesses[this.state.current_round-1];if(!r||!t)return;this.state.rounds[this.state.current_round-1]={location:{lat:r.lat,lng:r.lng,heading:r.heading,pitch:r.pitch,zoom:r.zoom,panoId:r.panoId?_(r.panoId):null},player_guess:{lat:t.lat,lng:t.lng,heading:t.heading,pitch:t.pitch,zoom:t.zoom,panoId:t.panoId?_(t.panoId):null},score:{amount:parseFloat((e=t?.roundScore)===null||e===void 0?void 0:e.amount)||0,unit:((n=t?.roundScore)===null||n===void 0?void 0:n.unit)||"points",percentage:((s=t?.roundScore)===null||s===void 0?void 0:s.percentage)||0},distance:{meters:{amount:parseFloat((v=(a=t?.distance)===null||a===void 0?void 0:a.meters)===null||v===void 0?void 0:v.amount)||0,unit:((p=(m=t?.distance)===null||m===void 0?void 0:m.meters)===null||p===void 0?void 0:p.unit)||"km"},miles:{amount:parseFloat((f=(g=t?.distance)===null||g===void 0?void 0:g.miles)===null||f===void 0?void 0:f.amount)||0,unit:((w=(S=t?.distance)===null||S===void 0?void 0:S.miles)===null||w===void 0?void 0:w.unit)||"miles"}}},this.state.total_score={amount:parseFloat((E=(y=i?.player)===null||y===void 0?void 0:y.totalScore)===null||E===void 0?void 0:E.amount)||0,unit:((I=(G=i?.player)===null||G===void 0?void 0:G.totalScore)===null||I===void 0?void 0:I.unit)||"points",percentage:((b=(k=i?.player)===null||k===void 0?void 0:k.totalScore)===null||b===void 0?void 0:b.percentage)||0},this.state.total_distance={meters:{amount:parseFloat((x=(F=(C=i?.player)===null||C===void 0?void 0:C.totalDistance)===null||F===void 0?void 0:F.meters)===null||x===void 0?void 0:x.amount)||0,unit:((q=(R=(D=i?.player)===null||D===void 0?void 0:D.totalDistance)===null||R===void 0?void 0:R.meters)===null||q===void 0?void 0:q.unit)||"km"},miles:{amount:parseFloat((T=(O=(N=i?.player)===null||N===void 0?void 0:N.totalDistance)===null||O===void 0?void 0:O.miles)===null||T===void 0?void 0:T.amount)||0,unit:((A=(W=(z=i?.player)===null||z===void 0?void 0:z.totalDistance)===null||W===void 0?void 0:W.miles)===null||A===void 0?void 0:A.unit)||"miles"}},this.state.map={id:i.map,name:i.mapName}}this.saveState(),this.events.dispatchEvent(new CustomEvent("round_end",{detail:this.state})),this.state.current_round===5&&this.events.dispatchEvent(new CustomEvent("game_end",{detail:this.state}))})}checkState(){const e=document.querySelector('div[class^="in-game_root__"]'),n=document.querySelector('div[class^="round-result_wrapper__"]'),s=document.querySelector('div[class^="result-layout_root__"] div[class^="result-overlay_overlayContent__"]');e&&(this.state.current_round!==this.getCurrentRound()||this.state.current_game_id!==this.getGameId()?(this.state.round_in_progress&&this.stopRound(),this.startRound()):n&&this.state.round_in_progress?this.stopRound():s&&this.state.game_in_progress&&(this.state.game_in_progress=!1))}}GeoGuessrEventFramework=new d,console.log("GeoGuessr Event Framework initialised: https://github.com/miraclewhips/geoguessr-event-framework")})();
