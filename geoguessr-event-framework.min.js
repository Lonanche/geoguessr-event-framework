var __awaiter=this&&this.__awaiter||function(d,m,i,r){function g(a){return a instanceof i?a:new i(function(l){l(a)})}return new(i||(i=Promise))(function(a,l){function f(o){try{c(r.next(o))}catch(_){l(_)}}function p(o){try{c(r.throw(o))}catch(_){l(_)}}function c(o){o.done?a(o.value):g(o.value).then(f,p)}c((r=r.apply(d,m||[])).next())})},GeoGuessrEventFramework;(function(){let d,m,i,r,g;function a(n){return new Promise(t=>setTimeout(t,n))}function l(n,t,e){const s=n.onload;n.onload=u=>{const h=window.google;h&&(t.disconnect(),e(h)),s&&s.call(n,u)}}function f(n){for(const t of n)for(const e of t.addedNodes){const s=e;if(s&&s.src&&s.src.startsWith("https://maps.googleapis.com/"))return s}return null}function p(n){new MutationObserver((t,e)=>{const s=f(t);s&&l(s,e,n)}).observe(document.documentElement,{childList:!0,subtree:!0})}function c(){const n=d.getPosition();return{lat:n.lat(),lng:n.lng()}}function o(){return __awaiter(this,void 0,void 0,function*(){return yield i,d?(yield a(100),new Promise(n=>{if(r){let t=window.google.maps.event.addListener(d,"status_changed",()=>{const e=c();r.lat!=e.lat&&r.lng!=e.lng&&(window.google.maps.event.removeListener(t),r=e,n(e))})}else{const t=c();r=t,n(t)}})):{lat:null,lng:null}})}i=new Promise((n,t)=>{document.addEventListener("DOMContentLoaded",e=>{p(()=>{if(!window.google)return t();const s=[];s.push(new Promise(u=>{window.google.maps.StreetViewPanorama=class extends window.google.maps.StreetViewPanorama{constructor(...h){super(...h),d=this,u()}}})),s.push(new Promise(u=>{window.google.maps.Map=class extends window.google.maps.Map{constructor(...h){super(...h),m=this,u()}}})),Promise.all(s).then(()=>n())})})});class _{constructor(){this.events=new EventTarget,this.state=this.defaultState(),this.init(),this.loadState();let t=document.querySelector("#__next");if(!t)return;new MutationObserver(this.checkState.bind(this)).observe(t,{subtree:!0,childList:!0}),i.then(()=>{m.addListener("click",s=>{!this.state.current_round||!this.state.round_in_progress||(this.state.rounds[this.state.current_round-1].player_guess={lat:s.latLng.lat(),lng:s.latLng.lng()})})})}init(){return __awaiter(this,void 0,void 0,function*(){return this.loadedPromise||(this.loadedPromise=Promise.resolve(this)),this.loadedPromise})}defaultState(){return{current_game_id:"",is_challenge_link:!1,current_round:0,round_in_progress:!1,game_in_progress:!0,total_score:0,rounds:[]}}loadState(){let t=window.localStorage.getItem("GeoGuessrEventFramework_STATE");if(!t)return;let e=JSON.parse(t);t&&(e.current_round=0,e.round_in_progress=!1,e.game_in_progress=!0,Object.assign(this.state,this.defaultState(),e),this.saveState())}saveState(){window.localStorage.setItem("GeoGuessrEventFramework_STATE",JSON.stringify(this.state))}getCurrentRound(){const t=document.querySelector('div[class^="status_inner__"]>div[data-qa="round-number"]'),e=t?.children[1].textContent;return e?parseInt(e.split(/\//gi)[0].trim()):0}getGameMode(){if(location.pathname.startsWith("/game/"))return"game";if(location.pathname.startsWith("/challenge/"))return"challenge"}getGameId(){return window.location.href.substring(window.location.href.lastIndexOf("/")+1)}startRound(){return __awaiter(this,void 0,void 0,function*(){this.getGameMode()&&(this.state.current_game_id!==this.getGameId()&&(this.state=this.defaultState()),this.state.current_round=this.getCurrentRound(),this.state.round_in_progress=!0,this.state.game_in_progress=!0,this.state.current_game_id=this.getGameId(),this.state.is_challenge_link=this.getGameMode()=="challenge",this.state.current_round&&(this.state.rounds[this.state.current_round-1]={score:0,location:{lat:null,lng:null},player_guess:{lat:null,lng:null}}),this.saveState(),this.state.current_round===1&&this.events.dispatchEvent(new CustomEvent("game_start",{detail:this.state})),this.events.dispatchEvent(new CustomEvent("round_start",{detail:this.state})),o().then(t=>{g=t}))})}stopRound(){var t;return __awaiter(this,void 0,void 0,function*(){this.state.round_in_progress=!1,yield a(1);const e=(t=document.querySelector('div[class^="round-result_pointsIndicatorWrapper__"] div[class^="shadow-text_root__"]'))===null||t===void 0?void 0:t.textContent;if(e){const s=parseInt(e.replace(/[^\d]/g,""));!isNaN(s)&&this.state.current_round&&(this.state.rounds[this.state.current_round-1].score=s)}this.state.total_score=this.state.rounds.reduce((s,u)=>s+=u.score,0),this.state.current_round&&g&&(this.state.rounds[this.state.current_round-1].location=g),this.saveState(),this.events.dispatchEvent(new CustomEvent("round_end",{detail:this.state})),this.state.current_round===5&&this.events.dispatchEvent(new CustomEvent("game_end",{detail:this.state}))})}checkState(){const t=document.querySelector(".game-layout"),e=document.querySelector('div[class^="round-result_wrapper__"]'),s=document.querySelector('div[class^="result-layout_root__"] div[class^="result-overlay_overlayContent__"]');t&&(this.state.current_round!==this.getCurrentRound()||this.state.current_game_id!==this.getGameId()?(this.state.round_in_progress&&this.stopRound(),this.startRound()):e&&this.state.round_in_progress?this.stopRound():s&&this.state.game_in_progress&&(this.state.game_in_progress=!1))}}GeoGuessrEventFramework=new _,console.log("GeoGuessr Event Framework initialised: https://github.com/miraclewhips/geoguessr-event-framework")})();
