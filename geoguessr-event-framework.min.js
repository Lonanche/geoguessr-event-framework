var __awaiter=this&&this.__awaiter||function(c,h,l,u){function _(o){return o instanceof l?o:new l(function(t){t(o)})}return new(l||(l=Promise))(function(o,t){function n(a){try{d(u.next(a))}catch(v){t(v)}}function s(a){try{d(u.throw(a))}catch(v){t(v)}}function d(a){a.done?o(a.value):_(a.value).then(n,s)}d((u=u.apply(c,h||[])).next())})},THE_WINDOW=unsafeWindow||window;(function(){let c;const h=THE_WINDOW.fetch;THE_WINDOW.fetch=function(){return function(...o){return __awaiter(this,void 0,void 0,function*(){if(/geoguessr.com\/api\/v3\/(games|challenges)\//.test(o[0].toString())){let t=yield h.apply(THE_WINDOW,o);return c=yield t.clone().json(),t}return h.apply(THE_WINDOW,o)})}}();function l(o){return c&&c.round===o.current_round?c:null}function u(o){for(var t=o.toString(),n="",s=0;s<t.length;s+=2)n+=String.fromCharCode(parseInt(t.substr(s,2),16));return n}class _{constructor(){this.events=new EventTarget,this.state=this.defaultState(),this.init(),this.loadState();let t=document.querySelector("#__next");if(!t)return;new MutationObserver(this.checkState.bind(this)).observe(t,{subtree:!0,childList:!0})}init(){return __awaiter(this,void 0,void 0,function*(){return this.loadedPromise||(this.loadedPromise=Promise.resolve(this)),this.loadedPromise})}defaultState(){return{current_game_id:"",is_challenge_link:!1,current_round:0,round_in_progress:!1,game_in_progress:!0,total_score:{amount:0,unit:"points",percentage:0},total_distance:{meters:{amount:0,unit:"km"},miles:{amount:0,unit:"miles"}},rounds:[],map:{id:"",name:""}}}loadState(){let t=window.localStorage.getItem("GeoGuessrEventFramework_STATE");if(!t)return;let n=JSON.parse(t);t&&(n.current_round=0,n.round_in_progress=!1,n.game_in_progress=!0,Object.assign(this.state,this.defaultState(),n),this.saveState())}saveState(){window.localStorage.setItem("GeoGuessrEventFramework_STATE",JSON.stringify(this.state))}getCurrentRound(){const t=document.querySelector('div[class^="status_inner__"]>div[data-qa="round-number"]'),n=t?.children[1].textContent;return n?parseInt(n.split(/\//gi)[0].trim()):0}getGameMode(){if(location.pathname.startsWith("/game/"))return"game";if(location.pathname.startsWith("/challenge/"))return"challenge"}getGameId(){return window.location.href.substring(window.location.href.lastIndexOf("/")+1)}startRound(){return __awaiter(this,void 0,void 0,function*(){if(!this.getGameMode())return;this.state.current_game_id!==this.getGameId()&&(this.state=this.defaultState()),this.state.current_round=this.getCurrentRound(),this.state.round_in_progress=!0,this.state.game_in_progress=!0,this.state.current_game_id=this.getGameId(),this.state.is_challenge_link=this.getGameMode()=="challenge";let t=l(this.state);t&&(this.state.map={id:t.map,name:t.mapName}),this.saveState(),this.state.current_round===1&&this.events.dispatchEvent(new CustomEvent("game_start",{detail:this.state})),this.events.dispatchEvent(new CustomEvent("round_start",{detail:this.state}))})}stopRound(){var t,n,s,d,a,v,m,p,g,f,S,w,y,G,E,I,k,b,F,C,x,D,R,q,N,O,T,z,W;return __awaiter(this,void 0,void 0,function*(){this.state.round_in_progress=!1;let i=l(this.state);if(i){const r=i.rounds[this.state.current_round-1],e=i.player.guesses[this.state.current_round-1];if(!r||!e)return;this.state.rounds[this.state.current_round-1]={location:{lat:r.lat,lng:r.lng,heading:r.heading,pitch:r.pitch,zoom:r.zoom,panoId:r.panoId?u(r.panoId):null},player_guess:{lat:e.lat,lng:e.lng,heading:e.heading,pitch:e.pitch,zoom:e.zoom,panoId:e.panoId?u(e.panoId):null},score:{amount:parseFloat((t=e?.roundScore)===null||t===void 0?void 0:t.amount)||0,unit:((n=e?.roundScore)===null||n===void 0?void 0:n.unit)||"points",percentage:((s=e?.roundScore)===null||s===void 0?void 0:s.percentage)||0},distance:{meters:{amount:parseFloat((a=(d=e?.distance)===null||d===void 0?void 0:d.meters)===null||a===void 0?void 0:a.amount)||0,unit:((m=(v=e?.distance)===null||v===void 0?void 0:v.meters)===null||m===void 0?void 0:m.unit)||"km"},miles:{amount:parseFloat((g=(p=e?.distance)===null||p===void 0?void 0:p.miles)===null||g===void 0?void 0:g.amount)||0,unit:((S=(f=e?.distance)===null||f===void 0?void 0:f.miles)===null||S===void 0?void 0:S.unit)||"miles"}}},this.state.total_score={amount:parseFloat((y=(w=i?.player)===null||w===void 0?void 0:w.totalScore)===null||y===void 0?void 0:y.amount)||0,unit:((E=(G=i?.player)===null||G===void 0?void 0:G.totalScore)===null||E===void 0?void 0:E.unit)||"points",percentage:((k=(I=i?.player)===null||I===void 0?void 0:I.totalScore)===null||k===void 0?void 0:k.percentage)||0},this.state.total_distance={meters:{amount:parseFloat((C=(F=(b=i?.player)===null||b===void 0?void 0:b.totalDistance)===null||F===void 0?void 0:F.meters)===null||C===void 0?void 0:C.amount)||0,unit:((R=(D=(x=i?.player)===null||x===void 0?void 0:x.totalDistance)===null||D===void 0?void 0:D.meters)===null||R===void 0?void 0:R.unit)||"km"},miles:{amount:parseFloat((O=(N=(q=i?.player)===null||q===void 0?void 0:q.totalDistance)===null||N===void 0?void 0:N.miles)===null||O===void 0?void 0:O.amount)||0,unit:((W=(z=(T=i?.player)===null||T===void 0?void 0:T.totalDistance)===null||z===void 0?void 0:z.miles)===null||W===void 0?void 0:W.unit)||"miles"}},this.state.map={id:i.map,name:i.mapName}}this.saveState(),this.events.dispatchEvent(new CustomEvent("round_end",{detail:this.state})),this.state.current_round===5&&this.events.dispatchEvent(new CustomEvent("game_end",{detail:this.state}))})}checkState(){const t=document.querySelector('div[class^="in-game_root__"]'),n=document.querySelector('div[class^="round-result_wrapper__"]'),s=document.querySelector('div[class^="result-layout_root__"] div[class^="result-overlay_overlayContent__"]');t&&(this.state.current_round!==this.getCurrentRound()||this.state.current_game_id!==this.getGameId()?(this.state.round_in_progress&&this.stopRound(),this.startRound()):n&&this.state.round_in_progress?this.stopRound():s&&this.state.game_in_progress&&(this.state.game_in_progress=!1))}}THE_WINDOW.GeoGuessrEventFramework||(THE_WINDOW.GeoGuessrEventFramework=new _,console.log("GeoGuessr Event Framework initialised: https://github.com/miraclewhips/geoguessr-event-framework"))})();
