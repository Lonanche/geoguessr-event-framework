var __awaiter=this&&this.__awaiter||function(c,h,r,l){function _(d){return d instanceof r?d:new r(function(o){o(d)})}return new(r||(r=Promise))(function(d,o){function t(a){try{s(l.next(a))}catch(u){o(u)}}function n(a){try{s(l.throw(a))}catch(u){o(u)}}function s(a){a.done?d(a.value):_(a.value).then(t,n)}s((l=l.apply(c,h||[])).next())})},GeoGuessrEventFramework;(function(){let c;const h=unsafeWindow||window,r=h.fetch;h.fetch=function(){return function(...o){return __awaiter(this,void 0,void 0,function*(){if(/geoguessr.com\/api\/v3\/(games|challenges)\//.test(o[0].toString())){let t=yield r.apply(h,o);return c=yield t.clone().json(),t}return r.apply(h,o)})}}();function l(o){return c&&c.round===o.current_round?c:null}function _(o){for(var t=o.toString(),n="",s=0;s<t.length;s+=2)n+=String.fromCharCode(parseInt(t.substr(s,2),16));return n}class d{constructor(){this.events=new EventTarget,this.state=this.defaultState(),this.init(),this.loadState();let t=document.querySelector("#__next");if(!t)return;new MutationObserver(this.checkState.bind(this)).observe(t,{subtree:!0,childList:!0})}init(){return __awaiter(this,void 0,void 0,function*(){return this.loadedPromise||(this.loadedPromise=Promise.resolve(this)),this.loadedPromise})}defaultState(){return{current_game_id:"",is_challenge_link:!1,current_round:0,round_in_progress:!1,game_in_progress:!0,total_score:{amount:0,unit:"points",percentage:0},total_distance:{meters:{amount:0,unit:"km"},miles:{amount:0,unit:"miles"}},rounds:[],map:{id:"",name:""}}}loadState(){let t=window.localStorage.getItem("GeoGuessrEventFramework_STATE");if(!t)return;let n=JSON.parse(t);t&&(n.current_round=0,n.round_in_progress=!1,n.game_in_progress=!0,Object.assign(this.state,this.defaultState(),n),this.saveState())}saveState(){window.localStorage.setItem("GeoGuessrEventFramework_STATE",JSON.stringify(this.state))}getCurrentRound(){const t=document.querySelector('div[class^="status_inner__"]>div[data-qa="round-number"]'),n=t?.children[1].textContent;return n?parseInt(n.split(/\//gi)[0].trim()):0}getGameMode(){if(location.pathname.startsWith("/game/"))return"game";if(location.pathname.startsWith("/challenge/"))return"challenge"}getGameId(){return window.location.href.substring(window.location.href.lastIndexOf("/")+1)}startRound(){return __awaiter(this,void 0,void 0,function*(){if(!this.getGameMode())return;this.state.current_game_id!==this.getGameId()&&(this.state=this.defaultState()),this.state.current_round=this.getCurrentRound(),this.state.round_in_progress=!0,this.state.game_in_progress=!0,this.state.current_game_id=this.getGameId(),this.state.is_challenge_link=this.getGameMode()=="challenge";let t=l(this.state);t&&(this.state.map={id:t.map,name:t.mapName}),this.saveState(),this.state.current_round===1&&this.events.dispatchEvent(new CustomEvent("game_start",{detail:this.state})),this.events.dispatchEvent(new CustomEvent("round_start",{detail:this.state}))})}stopRound(){var t,n,s,a,u,m,p,g,f,S,w,y,E,G,I,k,b,C,F,x,D,R,q,N,O,T,z,W,A;return __awaiter(this,void 0,void 0,function*(){this.state.round_in_progress=!1;let i=l(this.state);if(i){const v=i.rounds[this.state.current_round-1],e=i.player.guesses[this.state.current_round-1];this.state.rounds[this.state.current_round-1]={location:{lat:v.lat,lng:v.lng,heading:v.heading,pitch:v.pitch,zoom:v.zoom,panoId:v.panoId?_(v.panoId):null},player_guess:{lat:e.lat,lng:e.lng,heading:e.heading,pitch:e.pitch,zoom:e.zoom,panoId:e.panoId?_(e.panoId):null},score:{amount:parseFloat((t=e?.roundScore)===null||t===void 0?void 0:t.amount)||0,unit:((n=e?.roundScore)===null||n===void 0?void 0:n.unit)||"points",percentage:((s=e?.roundScore)===null||s===void 0?void 0:s.percentage)||0},distance:{meters:{amount:parseFloat((u=(a=e?.distance)===null||a===void 0?void 0:a.meters)===null||u===void 0?void 0:u.amount)||0,unit:((p=(m=e?.distance)===null||m===void 0?void 0:m.meters)===null||p===void 0?void 0:p.unit)||"km"},miles:{amount:parseFloat((f=(g=e?.distance)===null||g===void 0?void 0:g.miles)===null||f===void 0?void 0:f.amount)||0,unit:((w=(S=e?.distance)===null||S===void 0?void 0:S.miles)===null||w===void 0?void 0:w.unit)||"miles"}}},this.state.total_score={amount:parseFloat((E=(y=i?.player)===null||y===void 0?void 0:y.totalScore)===null||E===void 0?void 0:E.amount)||0,unit:((I=(G=i?.player)===null||G===void 0?void 0:G.totalScore)===null||I===void 0?void 0:I.unit)||"points",percentage:((b=(k=i?.player)===null||k===void 0?void 0:k.totalScore)===null||b===void 0?void 0:b.percentage)||0},this.state.total_distance={meters:{amount:parseFloat((x=(F=(C=i?.player)===null||C===void 0?void 0:C.totalDistance)===null||F===void 0?void 0:F.meters)===null||x===void 0?void 0:x.amount)||0,unit:((q=(R=(D=i?.player)===null||D===void 0?void 0:D.totalDistance)===null||R===void 0?void 0:R.meters)===null||q===void 0?void 0:q.unit)||"km"},miles:{amount:parseFloat((T=(O=(N=i?.player)===null||N===void 0?void 0:N.totalDistance)===null||O===void 0?void 0:O.miles)===null||T===void 0?void 0:T.amount)||0,unit:((A=(W=(z=i?.player)===null||z===void 0?void 0:z.totalDistance)===null||W===void 0?void 0:W.miles)===null||A===void 0?void 0:A.unit)||"miles"}},this.state.map={id:i.map,name:i.mapName}}this.saveState(),this.events.dispatchEvent(new CustomEvent("round_end",{detail:this.state})),this.state.current_round===5&&this.events.dispatchEvent(new CustomEvent("game_end",{detail:this.state}))})}checkState(){const t=document.querySelector('div[class^="in-game_root__"]'),n=document.querySelector('div[class^="round-result_wrapper__"]'),s=document.querySelector('div[class^="result-layout_root__"] div[class^="result-overlay_overlayContent__"]');t&&(this.state.current_round!==this.getCurrentRound()||this.state.current_game_id!==this.getGameId()?(this.state.round_in_progress&&this.stopRound(),this.startRound()):n&&this.state.round_in_progress?this.stopRound():s&&this.state.game_in_progress&&(this.state.game_in_progress=!1))}}GeoGuessrEventFramework=new d,console.log("GeoGuessr Event Framework initialised: https://github.com/miraclewhips/geoguessr-event-framework")})();
